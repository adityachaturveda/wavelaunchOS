# Story 2.3: Form Submission API

## Status
Ready

## Story

**As a** developer,
**I want** a secure endpoint that accepts application form submissions,
**so that** applicant data is validated and stored reliably.

## Acceptance Criteria

1. `POST /api/application-form/submit` endpoint created within the application-form app. @docs/prd/epic-details.md#us23-form-submission-api
2. Payload validated server-side using the shared Zod schema. @docs/prd/epic-details.md#us23-form-submission-api
3. Input sanitized to prevent injection attacks before persistence. @docs/prd/epic-details.md#us23-form-submission-api
4. Submission saved in `ApplicationFormSubmissions` table with status `Pending`. @docs/prd/epic-details.md#us23-form-submission-api
5. Duplicate submissions (same email within 30 days) return warning response without re-inserting. @docs/prd/epic-details.md#us23-form-submission-api
6. API returns appropriate HTTP status codes and error body on validation or persistence failure. @docs/prd/epic-details.md#us23-form-submission-api
7. Rate limiting applied (max 5 submissions per IP per hour). @docs/prd/epic-details.md#us23-form-submission-api
8. Successful submission returns JSON containing `submissionId`. @docs/prd/epic-details.md#us23-form-submission-api

## Tasks / Subtasks

- [ ] Implement API route (AC: 1, 2, 3) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Create `apps/application-form/app/api/application-form/submit/route.ts` using Next.js App Router handler. [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Parse and validate request body with shared Zod schema from Story 2.1. @docs/prd/epic-details.md#us21-application-form-schema-design
  - [ ] Sanitize text fields (trim, escape HTML) before passing to persistence layer. @docs/prd/technical-assumptions.md#service-architecture
- [ ] Persist submission (AC: 4, 5, 8) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Add Prisma model (if not already present) in `packages/database/prisma/schema.prisma` and run migration. @docs/prd/epic-details.md#us21-application-form-schema-design
  - [ ] Write repository helper in `packages/shared/application-form/submissions.ts` to insert and fetch submissions. [Source: architecture.md#4-project-structure-relevant-parts]
  - [ ] Return JSON payload with `submissionId` and duplicate warning message when applicable. @docs/prd/epic-details.md#us23-form-submission-api
  - [ ] Ensure migration artifacts are generated/applied before endpoint deploy (Story 2.1 dependency). @docs/prd/epic-details.md#us21-application-form-schema-design
- [ ] Duplicate detection logic (AC: 5) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Query existing submissions by normalized email within the past 30 days. [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Respond with HTTP 200 and `duplicate: true` metadata when duplicate detected. @docs/prd/epic-details.md#us23-form-submission-api
- [ ] Error handling & HTTP responses (AC: 6) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Map Zod validation errors to 422 with human-readable messages. [Source: architecture.md#1-overview]
  - [ ] Catch persistence exceptions and surface 500 with retry guidance. @docs/prd/technical-assumptions.md#service-architecture
- [ ] Rate limiting (AC: 7) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Implement middleware using `@upstash/ratelimit` or equivalent, keyed by IP. [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Configure Upstash Redis (or Vercel KV) connection via environment variables documented in runbook. @docs/runbooks/database-hosting.md#environment-configuration
  - [ ] Return 429 responses with `Retry-After` header when limit exceeded. @docs/prd/epic-details.md#us23-form-submission-api
- [ ] Wiring UI hand-off (AC: 1, 8) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Update Story 2.2 form call to point at live endpoint with feature flag toggle. @docs/stories/2.2-public-application-form-ui.md
  - [ ] Document response contract (`submissionId`, `duplicate`, `errors[]`) in `docs/api/application-form-submit.md`. @docs/prd/technical-assumptions.md#service-architecture

## Dev Notes

### Previous Story Insights
- Requires schema output from Story 2.1 (`packages/shared/validation/application-form.ts`) before API validation can be wired. @docs/prd/epic-details.md#us21-application-form-schema-design
- UI integration from Story 2.2 should switch from mock success to live endpoint once this API is deployed. @docs/stories/2.2-public-application-form-ui.md
- Duplicate responses should bubble `duplicate: true` in JSON to allow Story 2.2 UI to show a friendly warning. @docs/prd/epic-details.md#us23-form-submission-api

### Data Models
- `ApplicationFormSubmissions` table must include applicant email, payload JSON, status enum (`Pending`, `Processed`, `Rejected`), created/updated timestamps. @docs/prd/epic-details.md#us21-application-form-schema-design

### API Specifications
- Endpoint lives under application-form app to avoid CRM auth dependencies. [Source: architecture.md#2-key-architectural-decisions]
- Rate limiting should leverage existing monorepo middleware patterns (see authentication story for reference). @docs/stories/1.4-basic-authentication-system.md

### Component Specifications
- No UI components created; ensure response shape matches Story 2.2 expectations for submission states. @docs/stories/2.2-public-application-form-ui.md

### File Locations
- API route: `apps/application-form/app/api/application-form/submit/route.ts`. [Source: architecture.md#4-project-structure-relevant-parts]
- Shared repository utilities: `packages/shared/application-form/`. [Source: architecture.md#4-project-structure-relevant-parts]
- Prisma schema/migrations: `packages/database/prisma/`. [Source: architecture.md#4-project-structure-relevant-parts]

### Testing Requirements
- Add integration tests using Jest + Supertest for happy path, duplicate detection, validation failure, rate limit. @docs/prd/technical-assumptions.md#testing-requirements
- Mock Prisma client for unit-level checks on duplicate detection helper. [Source: architecture.md#2-key-architectural-decisions]

### Technical Constraints
- Endpoint must run within Next.js App Router server runtime (Edge not required). [Source: architecture.md#2-key-architectural-decisions]
- Rate limiting storage should align with deployment environment (e.g., Upstash Redis via Upstash for Vercel). [Source: architecture.md#1-overview]
- Provide fallback (disable rate limit with warning logs) if Redis credentials unavailable temporarily. [Source: architecture.md#1-overview]

## Testing

- [ ] Integration: Supertest suite covering success, duplicate, validation error, rate limit branches. @docs/prd/technical-assumptions.md#testing-requirements
- [ ] Unit: Duplicate detection helper ensures email normalization and window comparison. [Source: architecture.md#2-key-architectural-decisions]
- [ ] Manual: Trigger form submission from Story 2.2 UI to verify end-to-end flow. @docs/stories/2.2-public-application-form-ui.md
- [ ] Security: Attempt malicious payload (XSS, SQL injection strings) to confirm sanitization. @docs/prd/epic-details.md#us23-form-submission-api

## Change Log

| Date       | Version | Description                                     | Author |
| ---------- | ------- | ----------------------------------------------- | ------ |
| 2025-11-03 | 0.1     | Initial draft for application form submission API | Bob    |

## QA Results

- Pending
