# Story 1.6: Deployment Pipeline

## Status
Ready

## Story

**As a** developer,
**I want** an automated Vercel deployment pipeline for the monorepo,
**so that** both Studio OS apps ship reliably with preview and production environments.

## Acceptance Criteria

1. Vercel project is created and connected to the Git repository. @docs/prd/epic-details.md#epic-1-foundation--authentication
2. Required environment variables (`DATABASE_URL`, `NEXTAUTH_SECRET`, `NEXTAUTH_URL`, etc.) are configured in Vercel for Production, Preview, and Development. @docs/prd/epic-details.md#epic-1-foundation--authentication @docs/runbooks/database-hosting.md#environment-configuration
3. Both apps (`apps/application-form`, `apps/crm`) build successfully in Vercel with workspace-aware configuration. @docs/prd/epic-details.md#epic-1-foundation--authentication
4. Preview deployments run automatically for pull requests. @docs/prd/epic-details.md#epic-1-foundation--authentication
5. Production deployment triggers on `main` merges with status visibility. @docs/prd/epic-details.md#epic-1-foundation--authentication
6. Health check endpoint (`GET /api/health`) exists and returns 200 for uptime monitoring. @docs/prd/epic-details.md#epic-1-foundation--authentication

## Tasks / Subtasks

- [ ] Provision and connect Vercel project (AC: 1) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Create Vercel project linked to the monorepo Git provider with required access rights. @docs/prd/technical-assumptions.md#hosting--deployment [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Verify Vercel detects PNPM workspace and Next.js apps using the provided `pnpm-workspace.yaml`. @README.md#workspace-layout [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Confirm Vercel root directories set to `apps/crm` and `apps/application-form` respectively before triggering builds. [Source: architecture.md#4-project-structure-relevant-parts]
- [ ] Configure environment secrets across environments (AC: 2) [Source: architecture.md#1-overview]
  - [ ] Populate `DATABASE_URL`, `NEXTAUTH_SECRET`, `NEXTAUTH_URL`, `PRISMA_SCHEMA_PATH`, and `NEXT_PUBLIC_APP_URL` for Production/Preview/Development in Vercel following runbook guidance. @docs/runbooks/database-hosting.md#environment-configuration [Source: architecture.md#1-overview]
  - [ ] Ensure secrets align with `.env.example` placeholders and Supabase SSL requirements (`?sslmode=require`). @README.md#hosted-database-setup-supabaseneon @docs/runbooks/database-hosting.md#ssl-enforcement [Source: architecture.md#1-overview]
- [ ] Ensure both apps deploy successfully (AC: 3) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Configure Vercel project settings or `vercel.json` (if required) to build `apps/crm` and `apps/application-form` using PNPM filters. @README.md#getting-started [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Validate build logs for both apps and shared packages (Prisma client generation included). @docs/prd/technical-assumptions.md#repository-structure-monorepo [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Ensure `pnpm build` runs the root `prebuild` (Prisma generate) step before workspace builds succeed. [Source: architecture.md#2-key-architectural-decisions]
- [ ] Automate preview deployments (AC: 4) [Source: architecture.md#1-overview]
  - [ ] Confirm preview builds trigger on pull requests with unique preview URLs. @docs/prd/technical-assumptions.md#hosting--deployment [Source: architecture.md#1-overview]
  - [ ] Document preview QA expectations in repo README or runbook. @docs/stories/1.3-database-hosting-setup.md#dev-notes [Source: architecture.md#1-overview]
  - [ ] Capture failure-handling steps for preview builds (retry, inspect logs) in deployment notes. [Source: architecture.md#1-overview]
- [ ] Automate production deployment (AC: 5) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Configure Vercel production branch targeting `main` with required checks (lint/test) before deploy. @docs/prd/technical-assumptions.md#testing-requirements [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Enable deployment notifications to stakeholders (email or Slack integration). @docs/prd/epic-details.md#epic-1-foundation--authentication [Source: architecture.md#1-overview]
- [ ] Implement health check endpoint (AC: 6) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Add `apps/crm/app/api/health/route.ts` returning `{ status: "ok" }`. Mirror the same handler in `apps/application-form/app/api/health/route.ts`. @docs/prd/epic-details.md#epic-1-foundation--authentication [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Update deployment documentation with monitoring instructions referencing the endpoint. @docs/prd/technical-assumptions.md#monitoring--logging [Source: architecture.md#1-overview]
- [ ] Validation & sign-off (AC: 1-6) [Source: architecture.md#1-overview]
  - [ ] Run smoke tests against preview and production URLs ensuring environment variables loaded and health check responds 200. @docs/prd/technical-assumptions.md#testing-requirements [Source: architecture.md#1-overview]
  - [ ] Capture deployment screenshots/logs and link them in the story change log for audit. @docs/prd/epic-details.md#epic-1-foundation--authentication [Source: architecture.md#1-overview]
  - [ ] Record any mitigations for failed builds (e.g., rerun, configuration adjustments) before sign-off. [Source: architecture.md#1-overview]

## Dev Notes

### Previous Story Insights
- Ensure user management APIs from Story 1.5 deploy once pipeline is operational to avoid blocking admin workflows. @docs/stories/1.5-user-management-foundation.md

### Data Models
- No specific guidance found in architecture docs.

### API Specifications
- Health check endpoints must return HTTP 200 with JSON payloads to satisfy monitoring requirements. [Source: architecture.md#2-key-architectural-decisions]

### Component Specifications
- UI changes must continue to use shadcn/ui primitives with Tailwind customization as outlined in the component strategy. [Source: architecture.md#31-shadcnui-integration]

### File Locations
- Health check routes belong under `apps/<app>/app/api/health/route.ts` following App Router conventions. [Source: architecture.md#4-project-structure-relevant-parts]

### Testing Requirements
- Automated CI must execute `pnpm lint` and `pnpm test` to match deployment gate expectations. [Source: architecture.md#2-key-architectural-decisions]

### Technical Constraints
- Deployment workflows must respect the Next.js App Router and React stack defined for both applications. [Source: architecture.md#2-key-architectural-decisions]
- Maintain the security-first principle emphasized in the architecture overview when managing deployment secrets. [Source: architecture.md#1-overview]
- Secrets for all environments must remain consistent with `.env.example` placeholders and include Supabase SSL enforcement (`?sslmode=require`). @README.md#hosted-database-setup-supabaseneon @docs/runbooks/database-hosting.md#ssl-enforcement [Source: architecture.md#1-overview]
  - [ ] Record any mitigations for failed builds (e.g., rerun, configuration adjustments) before sign-off. [Source: architecture.md#1-overview]

### Previous Story Insights
- Ensure user management APIs from Story 1.5 deploy once pipeline is operational to avoid blocking admin workflows. @docs/stories/1.5-user-management-foundation.md

### Data Models
- No specific guidance found in architecture docs.

### API Specifications
- Health check endpoints must return HTTP 200 with JSON payloads to satisfy monitoring requirements. [Source: architecture.md#2-key-architectural-decisions]

### Component Specifications
- UI changes must continue to use shadcn/ui primitives with Tailwind customization as outlined in the component strategy. [Source: architecture.md#31-shadcnui-integration]

### File Locations
- Health check routes belong under `apps/<app>/app/api/health/route.ts` following App Router conventions. [Source: architecture.md#4-project-structure-relevant-parts]

### Testing Requirements
- Automated CI must execute `pnpm lint` and `pnpm test` to match deployment gate expectations. [Source: architecture.md#2-key-architectural-decisions]

### Technical Constraints
- Deployment workflows must respect the Next.js App Router and React stack defined for both applications. [Source: architecture.md#2-key-architectural-decisions]
- Maintain the security-first principle emphasized in the architecture overview when managing deployment secrets. [Source: architecture.md#1-overview]
*** End Patch

### Testing Standards
- Unit tests stored alongside features (e.g., `apps/crm/src/__tests__`, `packages/shared/__tests__`) must run during CI/CD per repository testing strategy. @docs/prd/technical-assumptions.md#testing-requirements

## Testing

- [ ] Automated: Vercel build runs `pnpm lint` and `pnpm test` with passing results. @package.json#scripts
- [ ] Preview smoke: hit preview URL `/api/health` and critical pages (`/login`, `/app`) to confirm environment variables load. @docs/prd/technical-assumptions.md#testing-requirements
- [ ] Production smoke: verify `/api/health` returns 200 post-deploy and authentication flow works with live secrets. @docs/prd/epic-details.md#epic-1-foundation--authentication
- [ ] Monitoring: configure alerting on health check failure (Vercel, Pingdom, or similar). @docs/prd/technical-assumptions.md#monitoring--logging

## Change Log

| Date       | Version | Description                  | Author |
| ---------- | ------- | ---------------------------- | ------ |
| 2025-11-02 | 0.1     | Initial draft for deployment pipeline story | Bob |
| 2025-11-02 | 0.2     | Promoted to Ready for development | James |

## QA Results

- Pending
