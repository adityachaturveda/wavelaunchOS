# Story 1.2: Database Schema Design

## Status

Ready for QA

## Story

**As a** developer,
**I want** a complete PostgreSQL database schema using Prisma,
**so that** all entities (Users, Creators, Brands, Projects, Credentials, AuditLogs) are properly modeled

## Acceptance Criteria

1. Prisma schema defines tables: Users, Creators, Brands, Projects, Credentials, ApplicationFormSubmissions, AuditLogs, AITemplates
2. Relationships established across tables (one-to-many, many-to-many where needed)
3. All tables include `createdAt` and `updatedAt` timestamps
4. Indexes created to support email lookups and foreign key performance
5. Initial Prisma migration files generated and applied
6. Seed data script created for development environments

## Tasks / Subtasks

- [x] Initialize Prisma in `/packages/database` and install required dependencies (`prisma`, `@prisma/client`) (AC: 1) [Source: docs/prd/technical-assumptions.md#database]
  - [x] Configure `prisma/schema.prisma` with PostgreSQL datasource and Prisma client generator (AC: 1)
- [x] Model core entities in `schema.prisma` (Users, Creators, Brands, Projects, Credentials, ApplicationFormSubmissions, AuditLogs, AITemplates) with required fields and enums (AC: 1) [Source: docs/prd/epic-details.md#epic-1-foundation--authentication]
  - [x] Define `createdAt`/`updatedAt` timestamp defaults on every model (AC: 3)
  - [x] Capture auditing fields where applicable (e.g., createdBy) (AC: 2)
- [x] Establish relations between models (e.g., Creator ‚Üî Brand, Projects linked to Creators/Brands, Credentials referencing owners) using Prisma relation syntax (AC: 2) [Source: docs/prd/epic-details.md#epic-1-foundation--authentication]
  - [x] Ensure many-to-many or join tables exist where relationships require (AC: 2)
- [x] Add database indexes for frequent queries (email uniqueness, foreign key lookups) using `@@index` and `@unique` annotations (AC: 4)
- [x] Generate and apply initial migration with `pnpm --filter @studio-os/database prisma migrate dev` (AC: 5)
  - [x] Verify migration succeeds against Supabase PostgreSQL instance (or placeholder database) (AC: 5)
- [x] Create `prisma/seed.ts` (or equivalent) to seed baseline data (admin user, sample creator/brand) (AC: 6) [Source: docs/prd/epic-details.md#epic-1-foundation--authentication]
  - [x] Register seed command in package scripts (e.g., `pnpm --filter @studio-os/database run seed`) (AC: 6)
- [x] Publish Prisma client to workspace consumers (ensure `@studio-os/shared` or app packages can import generated client) (AC: 1) [Source: docs/prd/technical-assumptions.md#service-architecture]
- [x] Update repository documentation with schema overview & migration/seed instructions (AC: 5, AC: 6) [Source: docs/prd/technical-assumptions.md#repository-structure-monorepo]

## Dev Notes

### Previous Story Insights
- Story 1.1 established pnpm workspaces and package directories (`/packages/database`, `/packages/shared`); reuse that structure for Prisma assets. [Source: docs/stories/1.1-project-setup-and-infrastructure.md#1-83]

### Data Models
- Required entities: Users, Creators, Brands, Projects, Credentials, ApplicationFormSubmissions, AuditLogs, AITemplates, including timestamps and relationships. [Source: docs/prd/epic-details.md#epic-1-foundation--authentication]
- Ensure Credentials model can support future encryption requirements outlined in Epic 4 (fields for encrypted value, associations). [Source: docs/prd.md#epic-4-credential-vault]

### API Specifications
- No API endpoints defined in this story; ensure schema supports upcoming authentication (NextAuth) and CRM APIs. [Source: docs/prd/technical-assumptions.md#authentication--authorization]

### Component Specifications
- Not applicable; schema work only. Documented UI components will consume Prisma models later. [Source: docs/front-end-spec.md#information-architecture-ia]

### File Locations
- Prisma assets live under `/packages/database` per monorepo structure; shared types/validators belong in `/packages/shared`. [Source: docs/prd/technical-assumptions.md#repository-structure-monorepo]
- Migrations stored in `/packages/database/prisma/migrations`; seed script under `/packages/database/prisma/seed.ts`. [Source: docs/prd/technical-assumptions.md#database]

### Testing Requirements
- Add Prisma format/validate checks and consider unit tests for seed data scripts; align with unit/integration strategy (Jest + Supertest). [Source: docs/prd/technical-assumptions.md#testing-requirements]

### Technical Constraints
- PostgreSQL 15+, Prisma ORM, hosted via Supabase/Neon (future story). Ensure schema compatible with NextAuth (credentials provider) and JSON fields for application data. [Source: docs/prd/technical-assumptions.md#database]
- Maintain strict TypeScript usage and pnpm workspace scripts when exposing generated client. [Source: docs/prd/technical-assumptions.md#additional-technical-assumptions-and-requests]

#### Testing
- Run `pnpm --filter @studio-os/database prisma validate` after schema changes.
- Execute migration against local database and ensure seed script completes without errors.
- Add CI step (future) for `pnpm --filter @studio-os/database run test` covering seed utilities.

## Testing

- [x] `pnpm --filter @studio-os/database prisma format`
- [x] `pnpm --filter @studio-os/database prisma validate`
- [x] Apply initial migration to Supabase Postgres and confirm schema
- [x] Execute seed script and verify records created

## Change Log

| Date       | Version | Description       | Author |
| ---------- | ------- | ----------------- | ------ |
| 2025-10-30 | 0.1     | Initial draft     | Bob    |
| 2025-10-30 | 1.0     | Schema, migration, and seed implemented; Supabase seeded | Dev Agent |

## Dev Agent Record

### Agent Model Used
_To be completed during development._

### Debug Log References
_To be completed during development._

### Completion Notes List
_To be completed during development._

### File List
_To be completed during development._

## QA Results

### Summary
- ‚úÖ **Pass** ‚Äì Story 1.2 meets all functional acceptance criteria and supporting documentation expectations.

### Evidence
1. `pnpm --filter @studio-os/database prisma format` ‚Äì schema formatting clean.
2. `pnpm --filter @studio-os/database prisma validate` ‚Äì schema validated against Supabase (`scripts/run-prisma-validate.ps1`).
3. Migration `20251030081609_init` applied via `scripts/run-prisma-migrate.ps1` (Supabase target) @packages/database/prisma/migrations/20251030081609_init/migration.sql#1-220.
4. `pnpm --filter @studio-os/database run seed` (Supabase connection) succeeded with env-configured admin password/credential.
5. Schema models, relations, and indexes verified @packages/database/prisma/schema.prisma#1-198.

### Risks / Follow-ups
- üîê Seed data currently uses placeholder encrypted credential value; replace with environment-specific encrypted payload before production launch.
- üìã Consider adding automated tests around seed script logic (hashing, idempotency) in future sprints.

### Gate Decision
- **PASS** ‚Äì Ready to proceed to next story.
