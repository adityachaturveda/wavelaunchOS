# Story 2.4: Automatic Creator/Brand Record Creation

## Status
Ready

## Story

**As a** founder,
**I want** application form submissions to automatically create creator and brand records,
**so that** new applicants appear in the CRM without manual data entry.

## Acceptance Criteria

1. Background processor (job/function) consumes form submissions and runs asynchronously. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
2. Creator record created in `Creators` table using submission data (name, contact, metadata). @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
3. Brand record created when brand information present; linked to creator. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
4. Creator-brand relationship established when both entities exist. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
5. Submission JSON stored on creator for audit context. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
6. Creator status set to "New Application" after processing. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
7. Submission status updated to "Processed" on success. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
8. Optional email notification to founders triggered (if enabled). @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation

## Tasks / Subtasks

- [ ] Design processing workflow (AC: 1) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Create queue or scheduled job handler under `packages/shared/application-form/processor.ts`. [Source: architecture.md#4-project-structure-relevant-parts]
  - [ ] Decide execution model (cron vs on-demand) documented with trade-offs. @docs/prd/technical-assumptions.md#service-architecture
- [ ] Persist creator records (AC: 2, 5, 6) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Map submission payload to `Creators` Prisma model, including JSON context field. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
  - [ ] Set initial `status` to "New Application" and capture metadata (source, timestamps). @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
- [ ] Persist brand records and relationship (AC: 3, 4, 7) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Upsert `Brands` entry when brand details present; skip if empty. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
  - [ ] Create linking table entry (CreatorBrand join) and update submission status to "Processed". @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
- [ ] Handle notifications (AC: 8) [Source: architecture.md#1-overview]
  - [ ] Integrate optional email service stub (e.g., Resend) behind feature flag. @docs/prd/technical-assumptions.md#service-architecture
  - [ ] Log notification dispatch in audit trail for compliance. @docs/prd/technical-assumptions.md#service-architecture
- [ ] Error handling & retries (AC: 1-7) [Source: architecture.md#2-key-architectural-decisions]
  - [ ] Implement retry logic with exponential backoff for transient DB failures. [Source: architecture.md#1-overview]
  - [ ] Move failed submissions to "Error" state with reason field; keep original payload. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation

## Dev Notes

### Previous Story Insights
- Depends on Story 2.3 to populate `ApplicationFormSubmissions` and signal duplicates before processing. @docs/stories/2.3-form-submission-api.md
- Creator/Brand base schema defined in earlier stories; ensure migrations aligned before automation runs. @docs/stories/1.2-database-schema-design.md

### Data Models
- `Creators`, `Brands`, and junction table must include references for submission linkage and status tracking. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
- Store submission JSON in creator `applicationContext` (JSONB) column for future reference. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation

### API Specifications
- Processor should be callable via internal API (`POST /api/admin/application-form/process`) for manual retries. @docs/prd/technical-assumptions.md#service-architecture
- Background execution may leverage Vercel Cron; document schedule and environment variables. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation

### Component Specifications
- No UI in this story; ensure change log entries captured for CRM dashboards in follow-up stories. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation

### File Locations
- Processing logic: `packages/shared/application-form/processor.ts`. [Source: architecture.md#4-project-structure-relevant-parts]
- Cron or API route triggers: `apps/application-form/app/api/admin/application-form/process/route.ts`. [Source: architecture.md#4-project-structure-relevant-parts]

### Testing Requirements
- Integration tests covering creator/brand creation, duplicate submissions, and error handling. @docs/prd/technical-assumptions.md#testing-requirements
- Unit tests for mapping utilities converting submission payload to DB records. [Source: architecture.md#2-key-architectural-decisions]
- Mock notification service to validate optional email dispatch without external calls. @docs/prd/technical-assumptions.md#testing-requirements

### Technical Constraints
- Processor must be idempotent; rerunning should not duplicate creators/brands. [Source: architecture.md#1-overview]
- Respect rate limits and quotas for external email provider if enabled. @docs/prd/technical-assumptions.md#service-architecture

## Testing

- [ ] Integration: End-to-end job run from submission to CRM records with database assertions. @docs/prd/technical-assumptions.md#testing-requirements
- [ ] Unit: Mapping functions and duplicate detection remain deterministic. [Source: architecture.md#2-key-architectural-decisions]
- [ ] Manual: Trigger processor (CLI or API) and verify new entries appear in CRM views. @docs/prd/epic-details.md#us24-automatic-creatorbrand-record-creation
- [ ] Notification: simulate optional email send and confirm audit log entry. @docs/prd/technical-assumptions.md#service-architecture

## Change Log

| Date       | Version | Description                                             | Author |
| ---------- | ------- | ------------------------------------------------------- | ------ |
| 2025-11-03 | 0.1     | Initial draft for automatic creator/brand record creation | Bob    |

## QA Results

- Pending
