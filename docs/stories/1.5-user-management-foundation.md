# Story 1.5: User Management Foundation

## Status
Ready

## Story

**As an** admin,
**I want** to create and manage user accounts for team members,
**so that** authorized people can securely access the CRM with appropriate permissions.

## Acceptance Criteria

1. Admins can create new user accounts by providing email, password, and role (Admin, Founder, Team Member).
2. Emails must be unique and validated; passwords must be hashed before storage and meet the existing security policy (12+ characters, mixed character classes) @docs/stories/1.4-basic-authentication-system.md.
3. Role-based access control middleware restricts admin APIs and UI routes to Admin role only.
4. Admin-only user list view in the CRM displays email, role, status (active/deactivated), and created/updated timestamps with server-side filtering/sorting.
5. Admins can deactivate/reactivate users and trigger password resets without exposing password hashes.
6. Every administrative action (create, role change, deactivate/reactivate, password reset) is logged for auditing.

## Tasks / Subtasks

- [ ] Define user management data requirements (AC: 1, 2)
  - [ ] Confirm Prisma `User` model fields align with required attributes (email, passwordHash, role, timestamps) @packages/database/prisma/schema.prisma
  - [ ] Verify seed script coverage and update to support creating admin accounts via API (avoid hard-coded secrets) @packages/database/prisma/seed.ts
- [ ] Implement admin-only user management API (AC: 1, 2, 5, 6)
  - [ ] Create `/apps/crm/app/api/admin/users/route.ts` supporting POST (create user) and GET (list users) with pagination
  - [ ] Introduce `/apps/crm/app/api/admin/users/[userId]/route.ts` for PATCH (role changes, deactivate/reactivate) and POST (password reset trigger)
  - [ ] Apply server-side validation with Zod schemas enforcing email uniqueness and password strength @packages/shared/auth/password.ts
  - [ ] Hash passwords using bcrypt before persistence and return masked success responses only
  - [ ] Emit audit log events for create/update/reset actions (stub helper if full audit story pending) @packages/shared
- [ ] Add role-based access control middleware (AC: 3)
  - [ ] Extend existing auth middleware to gate `/app/admin` and `/app/api/admin` routes to Admin roles only @apps/crm/middleware.ts
  - [ ] Provide utility for server components/API routes to assert roles (e.g., `requireRole("ADMIN")`) @apps/crm/src/auth/role.ts
- [ ] Build admin user management UI (AC: 1, 4, 5)
  - [ ] Create `/apps/crm/src/app/(admin)/users/page.tsx` listing users with email, role, status, created/updated with table sorting/filtering
  - [ ] Add actions for invite/create, deactivate/reactivate, and password reset (modal + forms using shadcn/ui)
  - [ ] Ensure UI consumes API routes with optimistic updates and toast error states
  - [ ] Surface Admin navigation entry linking to the user management page (header dropdown/sidebar) visible to Admins only @apps/crm/src/app/layouts
- [ ] Testing & validation (AC: 2, 3, 5, 6)
  - [ ] Unit test role guard utilities and API handlers (Vitest) @apps/crm/src/auth/__tests__
  - [ ] Integration test password hashing and audit logging paths (mock Prisma + bcrypt) @apps/crm/src/auth/__tests__
  - [ ] Manual QA: create user, attempt duplicate email, enforce role restrictions, deactivate/reactivate, trigger password reset, verify audit log entries

## Dev Notes

### Dependencies & Context
- Builds on authentication foundation from Story 1.4 (sessions, password policy, login flows).
- Prisma schema already contains `User` model with role enum (Admin/Founder/TeamMember) and seed script establishing admin account baseline @packages/database/prisma/schema.prisma.
- Audit logging infrastructure scoped for later stories—introduce minimal helper now that writes to `AuditLog` table or queue placeholder entries.
- Maintain existing CRM App Router organization (`/app/(group)/page.tsx`, `/app/api/.../route.ts`) and adhere to shared UI components.

### Implementation Considerations
- For password reset flows, initial scope may generate temporary passwords surfaced to admin; email notifications deferred until dedicated messaging story.
- Ensure admin APIs use NextAuth session checks plus role guard utilities to protect against CSRF/unauthorized access.
- Keep UI optimized for desktop (per UX goals); broader responsive tweaks can follow in layout/navigation stories.

### Testing Requirements
- Vitest suites should cover role guard logic, API validation errors, and audit log helper behavior.
- Manual QA must validate admin vs non-admin access, user lifecycle actions, and audit log visibility (if applicable UI exists).

## Testing

- [ ] Unit: role guard helper enforces Admin-only access
- [ ] Unit: user creation API rejects duplicate emails and weak passwords
- [ ] Integration: admin user creation persists hashed password and logs action
- [ ] Manual: create user, change role, deactivate/reactivate, verify non-admin cannot access user list

## Change Log

| Date       | Version | Description                  | Author |
| ---------- | ------- | ---------------------------- | ------ |
| 2025-11-01 | 0.1     | Initial draft for user management foundation | Bob |

## QA Results

### Review Date: 2025-11-01

### Reviewed By: Quinn (Test Architect)

### Story Readiness Assessment
- **Status:** PASS
- **Clarity Score:** 9/10 – Navigation discoverability task added; scope and testing remain clear.

### Key Findings
1. **Navigation Path Covered:** Tasks now include surfacing an Admin-only navigation entry, satisfying reachability requirements @docs/stories/1.5-user-management-foundation.md#21-40.
2. **Audit Log Stub Acceptable:** Tasks call out emitting audit log events even if the full system is pending, providing a clear expectation to log admin actions now @docs/stories/1.5-user-management-foundation.md#26-32.
3. **Testing Coverage Well-Scoped:** Unit, integration, and manual QA items map cleanly onto the acceptance criteria, including negative cases for duplicates and role enforcement @docs/stories/1.5-user-management-foundation.md#39-66.

### Compliance Check
- Goal & Context Clarity: **Pass** – Requirements align with Epic 1 user management goals.
- Technical Guidance: **Pass** – Tasks cover APIs, UI, navigation, and logging expectations.
- References: **Pass** – Reuses Story 1.4 password policy; links to schema and helpers are accurate.
- Self-Containment Assessment: **Pass** – Navigation and testing guidance now ensure story can be executed without guessing.
- Testing Guidance: **Pass** – Automated and manual coverage defined.

### Improvements Checklist
- [x] Add a task to surface the Admin User Management page in the CRM navigation (visible to Admins only).

### Security & Risk Notes
- Ensure temporary password reset flow shares credentials securely; documenting manual handoff is encouraged.

### Gate Status
- Gate: **PASS** – Story ready for development.
